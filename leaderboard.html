<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/">
    <title>–†–µ–π—Ç–∏–Ω–≥ | –®–ø–∏–æ–Ω - –û–Ω–ª–∞–π–Ω-–∏–≥—Ä–∞</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        .leaderboard-page main { max-width: 700px; margin: 0 auto; }
        .leaderboard-item { display: flex; align-items: center; gap: 20px; padding: 15px 20px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .leaderboard-item.top1 { border-color: #ffd700; background: rgba(255,215,0,0.1); }
        .leaderboard-item.top2 { border-color: #c0c0c0; background: rgba(192,192,192,0.1); }
        .leaderboard-item.top3 { border-color: #cd7f32; background: rgba(205,127,50,0.1); }
        .leaderboard-rank { font-size: 1.5rem; font-weight: 800; width: 40px; text-align: center; }
        .leaderboard-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .leaderboard-name { flex: 1; font-weight: 600; }
        .leaderboard-name a { color: inherit; text-decoration: none; }
        .leaderboard-name a:hover { text-decoration: underline; }
        .leaderboard-rating { font-size: 1.2rem; color: #4db8ff; font-weight: 700; }
        .leaderboard-stats { font-size: 0.9rem; color: #888; }
    </style>
</head>
<body class="dark-theme leaderboard-page">
    <div class="emoji-rain"></div>
    <div class="container">
        <header style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <h1><a href="/" style="color: inherit; text-decoration: none;"><i class="fas fa-user-secret"></i> –®–ü–ò–û–ù</a></h1>
            <div class="header-search" style="flex: 1; max-width: 260px; position: relative;">
                <input type="text" id="headerSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É..." autocomplete="off" style="width: 100%; padding: 8px 12px 8px 36px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: inherit;">
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888;"></i>
                <div id="headerSearchResults" class="search-results-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: rgba(30,40,50,0.98); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; max-height: 260px; overflow-y: auto; z-index: 1000;"></div>
            </div>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div id="notificationsWrap" style="position: relative;">
                        <button id="notificationsBell" class="sound-toggle-btn" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                            <i class="fas fa-bell"></i>
                            <span id="notificationsBadge">0</span>
                        </button>
                    </div>
                    <a href="/" style="color: #4db8ff; text-decoration: none;"><i class="fas fa-gamepad"></i> –ò–≥—Ä–∞—Ç—å</a>
                    <a href="/leaderboard" style="color: #4db8ff; text-decoration: none;"><i class="fas fa-trophy"></i> –†–µ–π—Ç–∏–Ω–≥</a>
                    <span id="headerAuth"></span>
                </div>
                <div class="theme-toggle-container">
                    <button id="soundToggleBtn" class="sound-toggle-btn" title="–í–∫–ª/–í—ã–∫–ª –∑–≤—É–∫–∏">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <span class="theme-label">üåô</span>
                    <label class="switch">
                        <input type="checkbox" id="themeToggle">
                        <span class="slider"></span>
                    </label>
                    <span class="theme-label">‚òÄÔ∏è</span>
                    <button id="emojiToggleBtn" class="emoji-toggle-btn" title="–í–∫–ª/–í—ã–∫–ª –ø–∞–¥–∞—é—â–∏–µ —ç–º–æ–¥–∑–∏">
                        <i class="fas fa-cloud-moon"></i>
                    </button>
                </div>
            </div>
        </header>
        <main>
            <div class="card">
                <h2><i class="fas fa-trophy"></i> –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
                <div id="leaderboardList"></div>
            </div>
        </main>
        <footer>
            <p>–ò–≥—Ä–∞ "–®–ø–∏–æ–Ω" | –†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</p>
        </footer>
    </div>
    <script src="/header.js"></script>
    <script>
        function getAvatarUrl(seed) {
            return 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + encodeURIComponent(seed || 'default') + '&backgroundColor=4db8ff';
        }
        async function loadLeaderboard() {
            try {
                const res = await fetch('/api/leaderboard');
                const data = await res.json();
                const list = document.getElementById('leaderboardList');
                list.innerHTML = '';
                data.top.forEach((u, i) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-item' + (i < 3 ? ' top' + (i + 1) : '');
                    const name = u.display_name || u.username;
                    div.innerHTML = `
                        <span class="leaderboard-rank">${i + 1}</span>
                        <img class="leaderboard-avatar" src="${getAvatarUrl(u.avatar_seed)}" alt="">
                        <div class="leaderboard-name"><a href="/profile/${u.id}">${escapeHtml(name)}</a></div>
                        <div class="leaderboard-rating">${u.rating ?? 0}</div>
                        <div class="leaderboard-stats">${u.games_played || 0} –∏–≥—Ä, ${u.wins || 0} –ø–æ–±–µ–¥</div>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                document.getElementById('leaderboardList').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }
        function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        async function updateHeaderAuth() {
            const el = document.getElementById('headerAuth');
            try {
                const res = await fetch('/api/auth/me', { credentials: 'same-origin' });
                const data = await res.json();
                if (data.user) {
                    el.innerHTML = `<a href="/profile/${data.user.id}" style="color: #4db8ff; text-decoration: none;">${escapeHtml(data.user.display_name || data.user.username)}</a> | <a href="#" id="logoutBtn" style="color: #ff6b6b; text-decoration: none;">–í—ã–π—Ç–∏</a>`;
                    document.getElementById('logoutBtn')?.addEventListener('click', async (e) => {
                        e.preventDefault();
                        await fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' });
                        location.reload();
                    });
                } else {
                    el.innerHTML = '<a href="/login" style="color: #4db8ff; text-decoration: none;">–í–æ–π—Ç–∏</a>';
                }
            } catch { el.innerHTML = '<a href="/login" style="color: #4db8ff; text-decoration: none;">–í–æ–π—Ç–∏</a>'; }
        }
        document.addEventListener('DOMContentLoaded', () => {
            updateHeaderAuth();
            loadLeaderboard();
            const headerSearch = document.getElementById('headerSearch');
            const headerSearchResults = document.getElementById('headerSearchResults');
            if (headerSearch && headerSearchResults) {
                let searchTimeout;
                headerSearch.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    const q = headerSearch.value.trim();
                    if (q.length < 2) { headerSearchResults.style.display = 'none'; headerSearchResults.innerHTML = ''; return; }
                    searchTimeout = setTimeout(async () => {
                        try {
                            const res = await fetch('/api/profile/search?q=' + encodeURIComponent(q));
                            const data = await res.json();
                            headerSearchResults.innerHTML = '';
                            if (data.users && data.users.length > 0) {
                                data.users.forEach(u => {
                                    const a = document.createElement('a');
                                    a.href = '/profile/' + u.id;
                                    a.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 10px 12px; color: inherit; text-decoration: none; border-bottom: 1px solid rgba(255,255,255,0.06);';
                                    a.innerHTML = '<img src="' + getAvatarUrl(u.avatar_seed || u.username) + '" style="width:36px;height:36px;border-radius:50%;object-fit:cover;"><div><strong>' + escapeHtml(u.display_name || u.username) + '</strong><br><small style="color:#888">@' + escapeHtml(u.username) + '</small></div>';
                                    headerSearchResults.appendChild(a);
                                });
                                headerSearchResults.style.display = 'block';
                            } else {
                                headerSearchResults.innerHTML = '<div style="padding:12px;color:#888;">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                                headerSearchResults.style.display = 'block';
                            }
                        } catch (e) { headerSearchResults.style.display = 'none'; }
                    }, 300);
                });
                document.addEventListener('click', (e) => {
                    if (!headerSearch.contains(e.target) && !headerSearchResults.contains(e.target)) headerSearchResults.style.display = 'none';
                });
            }
        });
    </script>
</body>
</html>
